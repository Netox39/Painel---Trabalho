<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel de Trabalho — Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="header">
   <div class="brand">
  <div class="logoBox">
    <img src="./logo.png" alt="Faculdade Christus Eusébio" class="logo-img">
  </div>

  <div class="brandText">
    <div class="appTitle"><b>Painel de Trabalho</b></div>
    <div class="appSub">Faculdade Christus Eusébio</div>
  </div>
</div>

    <div style="display:flex;align-items:center;gap:10px">
      <div class="clock" id="clock">—</div>
      <button class="btn" id="userBtn" title="Usuário">—</button>
      <button class="btn danger" id="logoutBtn">Sair</button>
    </div>
  </div>

  <div class="shell">
    <div class="sidebar">
      <div class="nav" id="nav"></div>
    </div>

    <div class="main">
      <div class="contentWrap">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px">
          <div>
            <div id="title" style="font-weight:900;font-size:16px">—</div>
            <div class="note" id="subtitle">—</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn" id="zoomOut" title="Diminuir zoom">−</button>
            <button class="btn" id="zoomReset" title="Resetar zoom">100%</button>
            <button class="btn" id="zoomIn" title="Aumentar zoom">+</button>
                        <button class="btn ok" id="addBtn">+ Adicionar</button>
          </div>
        </div>

        <div class="panel" id="panel"></div>
      </div>
    </div>
  </div>

  <div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHeader">
        <div id="modalTitle" style="font-weight:900">—</div>
        <button class="btn" id="modalClose">Fechar</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFooter" id="modalFooter"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <input type="file" id="xlsxFileInput" accept=".xlsx,.xls" style="display:none" />

  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="site.js"></script>
  <script src="app.js"></script>
  <script>
    setInterval(()=>clock.textContent=new Date().toLocaleString("pt-BR"), 1000);
  </script>
  <script>
    (function () {
      const $ = (id) => document.getElementById(id);

      // Supabase client (reusa se já existir)
      const getSb = () => {
        if (window.__sb) return window.__sb;
        if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY || !window.supabase) return null;
        window.__sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        return window.__sb;
      };

      // Toast simples
      function toast(msg, ms = 3500) {
        const el = $("toast");
        if (!el) { alert(msg); return; }
        el.textContent = msg;
        el.style.display = "block";
        el.style.opacity = "1";
        clearTimeout(window.__toastTimer);
        window.__toastTimer = setTimeout(() => {
          el.style.opacity = "0";
          setTimeout(() => { el.style.display = "none"; }, 250);
        }, ms);
      }

      // Modal simples usando o modal existente da página
      function openModal(title, bodyHtml, footerHtml) {
        $("modalTitle").textContent = title;
        $("modalBody").innerHTML = bodyHtml;
        $("modalFooter").innerHTML = footerHtml || "";
        const backdrop = $("modalBackdrop");
        backdrop.setAttribute("aria-hidden", "false");
        backdrop.style.display = "flex";
      }
      function closeModal() {
        const backdrop = $("modalBackdrop");
        backdrop.setAttribute("aria-hidden", "true");
        backdrop.style.display = "none";
      }

      // Botão "Fechar" padrão do seu modal
      const modalCloseBtn = $("modalClose");
      if (modalCloseBtn && !modalCloseBtn.__importBound) {
        modalCloseBtn.__importBound = true;
        modalCloseBtn.addEventListener("click", closeModal);
      }
      const backdrop = $("modalBackdrop");
      if (backdrop && !backdrop.__importBound) {
        backdrop.__importBound = true;
        backdrop.addEventListener("click", (e) => {
          if (e.target === backdrop) closeModal();
        });
      }

      function extractSpreadsheetId(url) {
        const m = String(url || "").match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
        return m ? m[1] : null;
      }
      function buildGvizCsvUrl(spreadsheetId, sheetName) {
        const encodedSheet = encodeURIComponent(sheetName);
        return `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:csv&sheet=${encodedSheet}`;
      }

      function normalizeRows(rows) {
        return rows.map((r) => ({
          codigo: r["Código"] ?? r["Codigo"] ?? "",
          andar: r["Andar"] ?? "",
          equipamento: r["Equipamento"] ?? "",
          patrimonio: r["Patrimônio"] ?? r["Patrimonio"] ?? "",
          setor: r["Setor"] ?? "",
          responsavel: r["Responsável"] ?? r["Responsavel"] ?? "",
          observacoes: r["Observações"] ?? r["Observacoes"] ?? "",
          status: r["Status"] ?? ""
        }));
      }

      async function importFromSheets({ sheetUrl, sheetTab }) {
        const id = extractSpreadsheetId(sheetUrl);
        if (!id) throw new Error("Não consegui identificar o ID da planilha. Cole um link padrão do Google Sheets.");
        if (!sheetTab) throw new Error("Informe o nome da aba (sheet).");

        const csvUrl = buildGvizCsvUrl(id, sheetTab);

        const res = await fetch(csvUrl, { method: "GET" });
        if (!res.ok) throw new Error(`Falha ao baixar CSV (HTTP ${res.status}). A planilha/aba está publicada e acessível?`);
        const csvText = await res.text();

        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        if (parsed.errors && parsed.errors.length) {
          console.warn(parsed.errors);
          throw new Error("Erro ao ler CSV. Verifique se a aba existe e se a planilha está publicada/acessível.");
        }

        return normalizeRows(parsed.data || []);
      }

      async function upsertInventarioByPatrimonio(rows) {
        const sb = getSb();
        if (!sb) throw new Error("Supabase não inicializado. Verifique o config.js e o carregamento do supabase-js.");

        // Patrimônio = chave: ignorar linhas sem patrimônio
        const valid = rows
          .map(r => ({...r, patrimonio: String(r.patrimonio || "").trim()}))
          .filter(r => r.patrimonio.length > 0);

        if (!valid.length) throw new Error("Nenhuma linha com 'Patrimônio' preenchido foi encontrada para importar.");

        // IMPORTANTE: no Supabase, a coluna 'patrimonio' deve ter UNIQUE para o upsert funcionar bem.
        const { error } = await sb
          .from("inventario")
          .upsert(valid, { onConflict: "patrimonio" });

        if (error) throw error;

        return { total: rows.length, valid: valid.length };
      }

      function tryRefreshInventarioUI(importedRows) {
        // tenta atualizar a tela sem quebrar seu app atual
        if (typeof window.renderInventarioTable === "function") {
          window.renderInventarioTable(importedRows);
          return true;
        }
        if (typeof window.loadInventario === "function") {
          window.loadInventario();
          return true;
        }
        if (typeof window.refreshCurrentView === "function") {
          window.refreshCurrentView();
          return true;
        }
        return false;
      }


      // ===== Importação: XLSX local + Google Sheets =====
      const fileInput = $("xlsxFileInput");

      async function importFromXlsxFile(file) {
        if (!window.XLSX) throw new Error("Biblioteca XLSX não carregou.");
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: "array" });
        const firstSheetName = wb.SheetNames && wb.SheetNames[0];
        if (!firstSheetName) throw new Error("Arquivo XLSX sem abas.");
        const ws = wb.Sheets[firstSheetName];
        const data = XLSX.utils.sheet_to_json(ws, { defval: "", raw: false });
        return normalizeRows(data || []);
      }

      function openSheetsModal() {
        openModal(
          "Importar do Google Sheets",
          `
            <div class="note" style="margin-bottom:10px">
              Dica: para importar sem login Google, publique a planilha (Arquivo → Publicar na web) ou garanta que ela esteja acessível.
            </div>

            <label class="note" for="gsheetUrl" style="display:block;margin:6px 0 4px">Link da planilha</label>
            <input id="gsheetUrl" class="input" type="text" placeholder="https://docs.google.com/spreadsheets/d/..." style="width:100%" />

            <label class="note" for="gsheetTab" style="display:block;margin:10px 0 4px">Nome da aba (sheet)</label>
            <input id="gsheetTab" class="input" type="text" placeholder="Ex: Inventário" style="width:100%" />

            <div id="importHint" class="note" style="margin-top:10px;opacity:.9"></div>
          `,
          `
            <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
              <button class="btn" id="doImportSheets">Importar</button>
              <button class="btn" id="cancelImportSheets">Cancelar</button>
            </div>
          `
        );

        $("cancelImportSheets").addEventListener("click", closeModal);
        $("doImportSheets").addEventListener("click", async () => {
          try {
            const sheetUrl = $("gsheetUrl").value.trim();
            const sheetTab = $("gsheetTab").value.trim();
            $("importHint").textContent = "Importando…";

            const rows = await importFromSheets({ sheetUrl, sheetTab });
            const { total, valid } = await upsertInventarioByPatrimonio(rows);

            const refreshed = tryRefreshInventarioUI(rows);
            $("importHint").textContent = `OK! ${valid}/${total} linhas importadas (com Patrimônio).`;

            toast(`Importação concluída: ${valid}/${total} linhas salvas no Supabase.`);
            if (!refreshed) setTimeout(() => location.reload(), 600);
          } catch (e) {
            console.error(e);
            $("importHint").textContent = `Erro: ${e.message || e}`;
            toast(`Erro ao importar: ${e.message || e}`);
          }
        });
      }

      function openImportChooser() {
        openModal(
          "Importar inventário",
          `
            <div class="note" style="margin-bottom:10px">
              Escolha como você quer importar.
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn ok" id="chooseXlsx">Importar XLSX (arquivo)</button>
              <button class="btn" id="chooseSheets">Importar Google Sheets</button>
            </div>
            <div id="importHint" class="note" style="margin-top:10px;opacity:.9"></div>
          `,
          `
            <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
              <button class="btn" id="cancelImport">Fechar</button>
            </div>
          `
        );

        $("cancelImport").addEventListener("click", closeModal);

        $("chooseXlsx").addEventListener("click", () => {
          if (!fileInput) return toast("Input de arquivo não encontrado.");
          fileInput.value = "";
          fileInput.click();
        });

        $("chooseSheets").addEventListener("click", () => {
          openSheetsModal();
        });
      }

      // Handler do XLSX (após escolher arquivo)
      if (fileInput && !fileInput.__importBound) {
        fileInput.__importBound = true;
        fileInput.addEventListener("change", async () => {
          const file = fileInput.files && fileInput.files[0];
          if (!file) return;
          try {
            const hint = $("importHint");
            if (hint) hint.textContent = "Lendo XLSX…";
            const rows = await importFromXlsxFile(file);
            const { total, valid } = await upsertInventarioByPatrimonio(rows);

            const refreshed = tryRefreshInventarioUI(rows);
            if (hint) hint.textContent = `OK! ${valid}/${total} linhas importadas (com Patrimônio).`;

            toast(`Importação XLSX concluída: ${valid}/${total} linhas salvas no Supabase.`);
            if (!refreshed) setTimeout(() => location.reload(), 600);
          } catch (e) {
            console.error(e);
            const hint = $("importHint");
            if (hint) hint.textContent = `Erro: ${e.message || e}`;
            toast(`Erro ao importar XLSX: ${e.message || e}`);
          }
        });
      }

      // Colocar botão Importar ao lado do "Exportar CSV"
      function ensureImportButtonNextToExport() {
        const buttons = Array.from(document.querySelectorAll("button"));
        const exportBtn = buttons.find(b => (b.textContent || "").trim().toLowerCase() === "exportar csv");
        if (!exportBtn) return false;

        // evita duplicar
        const parent = exportBtn.parentElement;
        if (!parent) return false;
        if (parent.querySelector('button[data-import="xlsx"]')) return true;

        const importBtn = document.createElement("button");
        importBtn.className = exportBtn.className || "btn";
        importBtn.textContent = "Importar";
        importBtn.title = "Importar XLSX / Google Sheets";
        importBtn.dataset.import = "xlsx";
        importBtn.addEventListener("click", openImportChooser);

        exportBtn.insertAdjacentElement("afterend", importBtn);
        return true;
      }

      // Tenta agora e observa mudanças (caso a tela seja renderizada depois)
      ensureImportButtonNextToExport();
      const mo = new MutationObserver(() => ensureImportButtonNextToExport());
      mo.observe(document.body, { childList: true, subtree: true });


    })();
  </script>

</body>
</html>
