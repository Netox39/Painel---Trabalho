<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redefinir senha — Painel de Trabalho</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(79,140,255,.18), transparent 60%),
        radial-gradient(700px 420px at 95% 10%, rgba(34,197,94,.12), transparent 55%),
        var(--bg, #0b1220);
      color: var(--text, #eaf0ff);
    }
    .cardX{
      width:min(520px,100%);
      background: linear-gradient(180deg, rgba(15,27,51,.94), rgba(15,27,51,.72));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: 0 18px 70px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .headX{
      padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(135deg, rgba(10,31,68,.92), rgba(16,42,99,.72));
    }
    .bodyX{padding:16px}
    .note{opacity:.85;font-size:12px;line-height:1.4}
  </style>
</head>
<body>
  <div class="cardX">
    <div class="headX">
      <div style="font-weight:900">Redefinir senha</div>
      <div class="note">Faculdade Christus Eusébio</div>
    </div>
    <div class="bodyX">
      <div class="note">Digite sua nova senha e salve.</div>

      <div class="grid" style="margin-top:12px">
        <div>
          <label class="note">Nova senha</label>
          <input class="input" id="newPass" type="password" placeholder="••••••••" autocomplete="new-password" />
        </div>
        <div>
          <label class="note">Confirmar senha</label>
          <input class="input" id="newPass2" type="password" placeholder="••••••••" autocomplete="new-password" />
        </div>
        <div class="note" id="msg" style="min-height:18px"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn primary" id="saveBtn" type="button">Salvar nova senha</button>
          <a class="btn" href="index.html" style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center">Voltar</a>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const $ = (id)=>document.getElementById(id);
    function setMsg(text, isErr=false){
      const el = $("msg");
      el.textContent = text || "";
      el.style.color = isErr ? "rgba(255,160,160,.95)" : "rgba(180,220,255,.95)";
    }
    function getCfg(){
      const url = window.SUPABASE_URL || window.supabaseUrl || (window.CONFIG && window.CONFIG.SUPABASE_URL) || "";
      const key = window.SUPABASE_ANON_KEY || window.supabaseAnonKey || (window.CONFIG && window.CONFIG.SUPABASE_ANON_KEY) || "";
      return { url, key };
    }
    const cfg = getCfg();
    if(!cfg.url || !cfg.key){
      setMsg("Configuração do Supabase não encontrada no config.js.", true);
      throw new Error("Missing Supabase config");
    }
    const client = window.supabase.createClient(cfg.url, cfg.key);

    // Reconhece sessão de reset (tokens vêm na URL)
    client.auth.getSession();

    $("saveBtn").onclick = async ()=>{
      const p1 = ($("newPass").value||"").trim();
      const p2 = ($("newPass2").value||"").trim();
      if(!p1 || p1.length < 6) return setMsg("A senha deve ter pelo menos 6 caracteres.", true);
      if(p1 !== p2) return setMsg("As senhas não conferem.", true);

      try{
        const { error } = await client.auth.updateUser({ password: p1 });
        if(error) throw error;
        setMsg("Senha atualizada com sucesso. Você já pode entrar.", false);
      }catch(e){
        setMsg(e?.message || "Erro ao atualizar senha.", true);
      }
    };
  </script>
</body>
</html>
