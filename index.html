<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel de Trabalho — Faculdade Christus</title>
<style>
:root{
  --bg:#0b1220;
  --text:#eaf0ff;
  --muted:#93a4c7;
  --border:rgba(255,255,255,.10);
  --headerH:72px;
  --btn:#4f8cff;
  --ok:#22c55e;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: radial-gradient(1200px 600px at 20% -10%, rgba(79,140,255,.22), transparent 60%),
              radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.16), transparent 55%),
              var(--bg);
  color:var(--text);
  height:100vh;
  overflow:hidden;
}
header{
  height:var(--headerH);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid var(--border);
  background: linear-gradient(180deg, rgba(15,27,51,.92), rgba(15,27,51,.70));
  backdrop-filter: blur(10px);
}
.brand{display:flex;align-items:center;gap:10px;min-width:260px}
.brand img{
  width:46px;height:46px;border-radius:12px;object-fit:cover;
  background:rgba(255,255,255,.05);
  border:1px solid var(--border);
}
.brand small{display:block;color:var(--muted);margin-top:2px}
.clock{color:var(--muted);font-size:12px}

.app{
  display:grid;
  grid-template-columns: 320px 1fr;
  height: calc(100vh - var(--headerH));
}
aside{
  border-right:1px solid var(--border);
  padding:12px;
  overflow:auto;
  background: linear-gradient(180deg, rgba(15,27,51,.72), rgba(15,27,51,.45));
}
.nav button{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
  width:100%;
  margin-bottom:8px;
  padding:10px 10px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.04);
  border-radius:12px;
  cursor:pointer;
  color:var(--text);
  transition:.12s ease;
}
.nav button:hover{transform: translateY(-1px); border-color: rgba(79,140,255,.35)}
.nav button.active{
  background:rgba(79,140,255,.18);
  border-color:rgba(79,140,255,.45);
}
.badge{
  font-size:11px;color:var(--muted);
  padding:2px 8px;border:1px solid var(--border);
  border-radius:999px;background:rgba(0,0,0,.12)
}

main{padding:12px;overflow:hidden}
.topbar{
  display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px
}
#title{font-weight:900;font-size:16px}
.hint{color:var(--muted);font-size:12px;margin-top:4px;max-width:820px}

.controls{
  display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end
}
.controls button{
  padding:10px 12px;border:none;border-radius:10px;
  background:rgba(255,255,255,.10);
  color:var(--text);
  cursor:pointer;
  font-weight:800;
}
.controls button:hover{background:rgba(79,140,255,.22)}
#editBtn{background:var(--btn)}
#editBtn:hover{background:#2f73ff}
#openBtn{
  background:rgba(34,197,94,.16);
  border:1px solid rgba(34,197,94,.35);
}
#openBtn:hover{background:rgba(34,197,94,.26)}
#zoomReset{min-width:74px;font-weight:800}

.content{
  height: calc(100vh - var(--headerH) - 78px);
  border:1px solid var(--border);
  border-radius:14px;
  overflow:auto;
  background: rgba(0,0,0,.10);
  position:relative;
}

/* Zoom wrapper */
.zoomWrap{ transform-origin: 0 0; }

/* Iframe sizing */
.iframeBox{ width: 1600px; height: 1100px; }
.iframeBox iframe{ width:100%; height:100%; border:0; background:white; display:block; }

/* Filtered table UI */
.toolbar{
  position: sticky;
  top:0;
  z-index:3;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  padding:10px;
  background: rgba(15,27,51,.95);
  border-bottom:1px solid var(--border);
}
.toolbar input, .toolbar select{
  padding:9px 10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: var(--text);
  outline: none;
}
.toolbar input::placeholder{color: rgba(234,240,255,.55)}
.toolbar .mini{ font-size:12px; color: var(--muted); margin-left:auto; }
.toolbar .group{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.toolbar button{
  padding:10px 12px;border:none;border-radius:10px;
  background:rgba(255,255,255,.10); color:var(--text); cursor:pointer; font-weight:800;
}
.toolbar button:hover{background:rgba(79,140,255,.22)}
.toolbar button.primary{background:rgba(79,140,255,.22)}
.toolbar button.green{background:rgba(34,197,94,.18); border:1px solid rgba(34,197,94,.35)}
.toolbar button.green:hover{background:rgba(34,197,94,.26)}
.toolbar button.ghost{background:rgba(255,255,255,.06)}
.tableWrap{padding:10px}
table{
  width:max-content;
  border-collapse:separate;
  border-spacing:0;
  background: rgba(255,255,255,.02);
  border:1px solid rgba(255,255,255,.10);
  border-radius:12px;
  overflow:hidden;
}
th, td{
  border-bottom:1px solid rgba(255,255,255,.08);
  border-right:1px solid rgba(255,255,255,.08);
  padding:8px 10px;
  font-size:13px;
  white-space:nowrap;
}
th{
  position: sticky;
  top:108px; /* abaixo das 2 linhas de toolbar */
  background: rgba(79,140,255,.12);
  z-index:2;
  font-weight:900;
}
tr:hover td{ background: rgba(255,255,255,.04); }

.pager{
  position: sticky;
  top:52px;
  z-index:2;
  display:flex;
  gap:8px;
  align-items:center;
  padding:10px;
  background: rgba(15,27,51,.95);
  border-bottom:1px solid var(--border);
}
.pager .spacer{flex:1}
.pager button{
  padding:8px 10px;border:none;border-radius:10px;
  background:rgba(255,255,255,.10); color:var(--text); cursor:pointer; font-weight:800;
}
.pager button:hover{background:rgba(79,140,255,.22)}
.pager select{
  padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06); color: var(--text);
}

@media (max-width: 980px){
  body{overflow:auto}
  .app{grid-template-columns:1fr;height:auto}
  aside{border-right:none;border-bottom:1px solid var(--border)}
  .content{height:70vh}
  .iframeBox{width:1200px;height:900px}
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="logo.png" alt="Logo">
    <div>
      <div><b>Painel de Trabalho</b></div>
      <small>Faculdade Christus</small>
    </div>
  </div>
  <div class="clock" id="clock">—</div>
</header>

<div class="app">
  <aside>
    <div class="nav" id="nav"></div>
  </aside>

  <main>
    <div class="topbar">
      <div>
        <div id="title">—</div>
        <div class="hint" id="hint">
          A aba <b>Controle de Inventário</b> agora tem filtros bonitos (dropdown) + pesquisa + paginação + exportação.
          As demais continuam embutidas (visualização), mas você pode abrir no Sheets.
        </div>
      </div>

      <div class="controls">
        <button id="zoomOut" title="Diminuir zoom">−</button>
        <button id="zoomReset" title="Resetar zoom">100%</button>
        <button id="zoomIn" title="Aumentar zoom">+</button>
        <button id="openBtn" title="Abrir no Google Sheets (com filtros)">Abrir no Sheets</button>
        <button id="editBtn" title="Abrir para edição (admin)">Editar</button>
      </div>
    </div>

    <div class="content" id="content"></div>
  </main>
</div>

<script>
/* =====================
   CONFIG
===================== */
const isAdmin = new URLSearchParams(location.search).get("admin")==="1";
const editBtn = document.getElementById("editBtn");
editBtn.style.display = isAdmin ? "inline-block" : "none";

const zoomInBtn = document.getElementById("zoomIn");
const zoomOutBtn = document.getElementById("zoomOut");
const zoomResetBtn = document.getElementById("zoomReset");
const openBtn = document.getElementById("openBtn");

const u = (b) => b + "?widget=true&headers=false";

const tabs = [
  {
    name:"Controle de Inventário",
    tag:"Filtro",
    type:"table",
    csvUrl:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTuk8e_LjYUhZjKL1irUu61to09DTsk7fXnmbN_ZgJ8FSW-qFw1Bi5VznDXC7tRGyhMvgTg5QlAADE9/pub?gid=1099818557&single=true&output=csv",
    url:u("https://docs.google.com/spreadsheets/d/e/2PACX-1vTuk8e_LjYUhZjKL1irUu61to09DTsk7fXnmbN_ZgJ8FSW-qFw1Bi5VznDXC7tRGyhMvgTg5QlAADE9/pubhtml"),
    editUrl:"https://docs.google.com/spreadsheets/d/1QVhGPsB8g9BsU5gIoPFNBslsg18zsqLz96yqlwRXdHs/edit?gid=1099818557#gid=1099818557",
  },
  {
    name:"Controle de Envios e Retornos",
    tag:"Tabela",
    type:"iframe",
    url:u("https://docs.google.com/spreadsheets/d/e/2PACX-1vR8oJdwz52RcOHzwlutBJ-oznwbO2psOOkFnVb2JLY5Rpzd9zac6JZQ30YBladU5lvt2FiTUALCv57R/pubhtml"),
    editUrl:"https://docs.google.com/spreadsheets/d/1NDNQXnTDX-uKC80Q-TIEn2Y1R4ZoFhjsyc3uaFNwaTI/edit?gid=2092291561#gid=2092291561"
  },
  {
    name:"Mapeamento Ar Condicionado",
    tag:"Mapa",
    type:"iframe",
    url:u("https://docs.google.com/spreadsheets/d/e/2PACX-1vSWcrg5z_S3YUhEqDrshtpKO9uejmEv2KhI70RfdeGuPxhm_UuAx7yl5y8Jpe5BMA/pubhtml"),
    editUrl:"https://docs.google.com/spreadsheets/d/1yNSd8jrSxJGdU2xDaKMhwdkgpE0BThIX/edit?gid=353718000#gid=353718000"
  },
  {
    name:"Ramais Internos",
    tag:"Contato",
    type:"iframe",
    url:u("https://docs.google.com/spreadsheets/d/e/2PACX-1vS4gESNTCskkqwJDwDEdszFOOWBsPRbNZj1pzr0KfvOyfxVCMfBq9yRZ9N6OQRmkrWjNCRSNHv0t88-/pubhtml"),
    editUrl:"https://docs.google.com/spreadsheets/d/1_vR44u298xUtvNu9ifStkcZodM1m3SWUDDJb_naNDx4/edit?gid=2034627358#gid=2034627358"
  },
  {
    name:"Equipamentos com Defeito",
    tag:"RMA",
    type:"iframe",
    url:u("https://docs.google.com/spreadsheets/d/e/2PACX-1vS-wJl57NMoEHSiVWPKm4R32h9cQbavN7GLWoXWoZS37zZcvUpoJl9P2_cTx7VXTVzcPk9nNmQdpmhV/pubhtml"),
    editUrl:"https://docs.google.com/spreadsheets/d/11CwMnpzrB5zb8oY01Rx2Iddj9a5ZueF9Idxl80Tvpmg/edit?gid=0#gid=0"
  }
];

/* =====================
   HELPERS
===================== */
function toViewUrl(editUrl){
  const m = editUrl.match(/https:\/\/docs\.google\.com\/spreadsheets\/d\/([^\/]+)\//);
  if(!m) return editUrl;
  const id = m[1];
  return `https://docs.google.com/spreadsheets/d/${id}/view?usp=sharing`;
}

// CSV parser simples
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0;i<text.length;i++){
    const c = text[i];
    if(c === '"'){
      if(inQuotes && text[i+1] === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if(c === ',' && !inQuotes){
      row.push(cur); cur = "";
    } else if((c === '\n' || c === '\r') && !inQuotes){
      if(c === '\r' && text[i+1] === '\n') i++;
      row.push(cur);
      if(row.some(v => (v ?? "").toString().trim() !== "")) rows.push(row);
      row = []; cur = "";
    } else {
      cur += c;
    }
  }
  row.push(cur);
  if(row.some(v => (v ?? "").toString().trim() !== "")) rows.push(row);
  return rows;
}

function norm(s){
  return (s ?? "").toString().trim().toUpperCase()
    .normalize("NFD").replace(/\p{Diacritic}/gu, "");
}

function csvEscape(v){
  const s = (v ?? "").toString();
  if(/[",\n\r]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
  return s;
}

/* =====================
   UI + STATE
===================== */
const nav = document.getElementById("nav");
const content = document.getElementById("content");
const titleEl = document.getElementById("title");

let current = null;
let zoom = 1;

function applyZoom(){
  const wrap = document.getElementById("zoomWrap");
  if(!wrap) return;
  wrap.style.transform = `scale(${zoom})`;
  zoomResetBtn.textContent = Math.round(zoom*100) + "%";
}

zoomInBtn.onclick = () => { zoom = Math.min(1.6, +(zoom + 0.1).toFixed(2)); applyZoom(); };
zoomOutBtn.onclick = () => { zoom = Math.max(0.6, +(zoom - 0.1).toFixed(2)); applyZoom(); };
zoomResetBtn.onclick = () => { zoom = 1; applyZoom(); };

openBtn.onclick = () => {
  if(!current) return;
  window.open(toViewUrl(current.editUrl), "_blank", "noopener");
};

editBtn.onclick = () => {
  if(current?.editUrl) window.open(current.editUrl, "_blank", "noopener");
};

tabs.forEach((t,i)=>{
  const b = document.createElement("button");
  b.innerHTML = `<span>${t.name}</span><span class="badge">${t.tag}</span>`;
  b.onclick = () => render(i);
  nav.appendChild(b);
});

/* =====================
   FILTER TABLE (pretty)
===================== */
function findHeaderIndex(header, keywords){
  // procura coluna cujo nome contenha qualquer keyword
  for(let i=0;i<header.length;i++){
    const h = norm(header[i]);
    for(const k of keywords){
      if(h.includes(k)) return i;
    }
  }
  return -1;
}

async function renderTable(tab){
  content.innerHTML = `
    <div id="zoomWrap" class="zoomWrap">
      <div class="toolbar" id="tb1">
        <div class="group">
          <input id="q" placeholder="Pesquisar (todas as colunas)..." />
          <button class="primary" id="apply">Filtrar</button>
          <button class="ghost" id="clear">Limpar</button>
          <button class="green" id="export">Exportar CSV</button>
        </div>
        <span class="mini" id="meta">—</span>
      </div>

      <div class="pager" id="tb2">
        <div class="group" id="fieldFilters"></div>
        <div class="spacer"></div>
        <span style="color:var(--muted);font-size:12px" id="pageInfo">—</span>
        <button id="prev">◀</button>
        <button id="next">▶</button>
        <select id="pageSize">
          <option value="25">25/pg</option>
          <option value="50" selected>50/pg</option>
          <option value="100">100/pg</option>
          <option value="200">200/pg</option>
        </select>
      </div>

      <div class="tableWrap">
        <div style="color:var(--muted);padding:8px" id="loading">Carregando dados...</div>
        <div id="tableHost"></div>
      </div>
    </div>
  `;

  applyZoom();

  let rows;
  try{
    const res = await fetch(tab.csvUrl, {cache:"no-store"});
    const txt = await res.text();
    rows = parseCSV(txt);
  }catch(e){
    document.getElementById("loading").textContent = "Não foi possível carregar o CSV. Verifique se a planilha está publicada (Publicar na web).";
    return;
  }

  if(!rows || rows.length < 2){
    document.getElementById("loading").textContent = "CSV vazio ou sem dados.";
    return;
  }

  const header = rows[0];
  const data = rows.slice(1);
  document.getElementById("loading").remove();

  // mapear colunas pelos nomes (flexível)
  const idxEquip = findHeaderIndex(header, ["EQUIP"]);
  const idxAndar = findHeaderIndex(header, ["ANDAR"]);
  const idxSetor = findHeaderIndex(header, ["SETOR"]);
  const idxPat = findHeaderIndex(header, ["PATRIM"]);
  const idxResp = findHeaderIndex(header, ["RESPONS"]);
  const idxObs  = findHeaderIndex(header, ["OBSERV"]);

  const fields = [
    {key:"equip", label:"Equipamento", idx: idxEquip},
    {key:"andar", label:"Andar", idx: idxAndar},
    {key:"setor", label:"Setor", idx: idxSetor},
    {key:"pat",   label:"Patrimônio", idx: idxPat},
    {key:"resp",  label:"Responsável", idx: idxResp},
    {key:"obs",   label:"Observações", idx: idxObs},
  ].filter(f => f.idx >= 0);

  // construir dropdowns com valores únicos
  const fieldFilters = document.getElementById("fieldFilters");
  const selects = {};

  function uniqueValues(idx){
    const s = new Set();
    for(const r of data){
      const v = (r[idx] ?? "").toString().trim();
      if(v) s.add(v);
    }
    return Array.from(s).sort((a,b)=> a.localeCompare(b, "pt-BR"));
  }

  for(const f of fields){
    const sel = document.createElement("select");
    sel.id = "f_" + f.key;
    sel.innerHTML = `<option value="">${f.label} (todos)</option>`;
    for(const v of uniqueValues(f.idx)){
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    }
    fieldFilters.appendChild(sel);
    selects[f.key] = sel;
  }

  // State for filters/pagination
  let filtered = data.slice();
  let page = 1;
  let pageSize = parseInt(document.getElementById("pageSize").value, 10);

  const meta = document.getElementById("meta");
  const pageInfo = document.getElementById("pageInfo");

  function applyFilters(){
    const q = (document.getElementById("q").value || "").trim();
    const qn = norm(q);

    filtered = data.filter(r => {
      // search all
      if(qn){
        const ok = r.some(cell => norm(cell).includes(qn));
        if(!ok) return false;
      }
      // field filters (exact match on dropdown)
      for(const f of fields){
        const sel = selects[f.key];
        if(!sel) continue;
        const chosen = (sel.value || "").trim();
        if(chosen){
          const cell = (r[f.idx] ?? "").toString().trim();
          if(cell !== chosen) return false;
        }
      }
      return true;
    });

    page = 1;
    renderPage();
  }

  function renderPage(){
    const host = document.getElementById("tableHost");
    const total = filtered.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    page = Math.min(page, totalPages);

    const start = (page-1)*pageSize;
    const end = Math.min(total, start + pageSize);
    const slice = filtered.slice(start, end);

    meta.textContent = `${total} registro(s) • ${fields.length ? "Filtros ativos disponíveis" : "Filtro por pesquisa"}`;
    pageInfo.textContent = `Página ${page}/${totalPages} • Mostrando ${start+1}-${end}`;

    const t = document.createElement("table");
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    header.forEach(h=>{
      const th = document.createElement("th");
      th.textContent = h || "";
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    t.appendChild(thead);

    const tbody = document.createElement("tbody");
    slice.forEach(r=>{
      const tr = document.createElement("tr");
      for(let i=0;i<header.length;i++){
        const td = document.createElement("td");
        td.textContent = (r[i] ?? "");
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });
    t.appendChild(tbody);

    host.innerHTML = "";
    host.appendChild(t);
  }

  function exportCSV(){
    const lines = [];
    lines.push(header.map(csvEscape).join(","));
    for(const r of filtered){
      const row = [];
      for(let i=0;i<header.length;i++) row.push(csvEscape(r[i] ?? ""));
      lines.push(row.join(","));
    }
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "controle_inventario_filtrado.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Hook events
  document.getElementById("apply").onclick = applyFilters;
  document.getElementById("clear").onclick = () => {
    document.getElementById("q").value = "";
    for(const f of fields){ if(selects[f.key]) selects[f.key].value = ""; }
    filtered = data.slice();
    page = 1;
    renderPage();
  };
  document.getElementById("export").onclick = exportCSV;

  document.getElementById("prev").onclick = () => { page = Math.max(1, page-1); renderPage(); };
  document.getElementById("next").onclick = () => { 
    const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
    page = Math.min(totalPages, page+1); 
    renderPage(); 
  };

  document.getElementById("pageSize").onchange = (e) => {
    pageSize = parseInt(e.target.value, 10);
    page = 1;
    renderPage();
  };

  // change on dropdown = auto apply
  for(const f of fields){
    if(selects[f.key]) selects[f.key].onchange = applyFilters;
  }

  // Enter on search applies
  document.getElementById("q").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") applyFilters();
  });

  // Initial render
  filtered = data.slice();
  renderPage();
}

function renderIframe(tab){
  content.innerHTML = `
    <div id="zoomWrap" class="zoomWrap">
      <div class="iframeBox">
        <iframe src="${tab.url}" loading="lazy" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  `;
  applyZoom();
}

async function render(i){
  current = tabs[i];
  titleEl.textContent = current.name;

  document.querySelectorAll(".nav button").forEach((b, idx) => b.classList.toggle("active", idx===i));

  if(current.type === "table"){
    await renderTable(current);
  }else{
    renderIframe(current);
  }
}

/* =====================
   START
===================== */
render(0);

setInterval(()=>{
  document.getElementById("clock").innerText = new Date().toLocaleString("pt-BR");
}, 1000);
</script>

</body>
</html>
